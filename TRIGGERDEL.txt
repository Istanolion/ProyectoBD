CREATE OR REPLACE TRIGGER tgPrestamoDEL
BEFORE DELETE
ON prestamo
FOR EACH ROW
DECLARE	
vMultaMonto NUMBER;	
vDifFecha NUMBER;
vAdeudo NUMBER;
BEGIN
SELECT adeudo INTO vAdeudo
FROM lector
WHERE idLector = :OLD.idLector;	
vDifFecha := TRUNC(TO_NUMBER(SYSDATE-:OLD.fechaven));
IF vDifFecha>'0' then
if :OLD.hMulta='N' THEN
vMultaMonto :=ftMulta(:OLD.fechaDevl);
spMulta(:OLD.idPrestamo,vMultaMonto,vDifFecha);
--UNA BANDERA QUE NOS DICE QUE EL PRESTAMO YA TIENE UNA MULTA
UPDATE prestamo
SET hMulta = 'Y'
WHERE (idPrestamo = :OLD.idPrestamo);
RAISE_APPLICATION_ERROR(-20013,'SOLO SE PODRA BORRAR DE PRESTAMO SI SE LIQUIDA LA MULTA DE '||vMultaMonto||' PESOS');
--ESTE CASO NO PERMITIRA EL BORRADO POR QUE YA SE TIENE REGISTRADA LA MULTA
--Y ESTA NO SE HA LIQUIDADO, SI EL ADEUDO ES 0 NO SE ENTRA AQUI,
--SE PERMITE EL BORRADO
ELSIF :OLD.hMulta = 'Y' THEN
RAISE_APPLICATION_ERROR(-20013,'SOLO SE PODRA BORRAR DE PRESTAMO SI SE LIQUIDA LA MULTA DE '||vMultaMonto||' PESOS');	
END IF;
end if;
END tgPrestamodel;
/